{"ast":null,"code":"import { db } from '../../lib/firebase';\nimport auth0 from '../../lib/auth0';\nimport getCurrentDate from '../../util/getCurrentDate';\nexport default async function (req, res) {\n  console.log(req.query);\n  console.log(req.headers); // const {userId} = req.\n  // return res.json({ ok: true });\n  // const session = await auth0.getSession(req);\n  // // Verifica se o usuário está logado\n  // if (!session) {\n  //   return res.status(401).json({\n  //     props: {\n  //       isAuth: false,\n  //     },\n  //   });\n  // }\n\n  /*\n   * Verifica se o usuário já cadastrou seu status diario\n   */\n\n  const currentDate = getCurrentDate();\n  const userDailyStatus = await db.collection('users').doc(session.user.sub).collection('history').doc(currentDate).get();\n  const todayRegistered = userDailyStatus.data();\n\n  if (!todayRegistered) {\n    return res.json({\n      props: {\n        isAuth: true,\n        hasRegisteredDailyStatus: false,\n        user: session.user\n      }\n    });\n  }\n\n  const filter = req.query;\n  const coordinates = req.body;\n  /* Caso o usuário já tenha cadastrado seu status diário, será verificado\n   * todos os usúarios que estao proximos dele\n   */\n\n  const nearbyUsers = await db.collection('history').doc('2020-04-20').collection('all').where('status', '==', filter).near({\n    center: coordinates,\n    radius: 10000\n  }).get();\n  const nearbyUsersList = [];\n  nearbyUsers.docs.forEach(doc => {\n    nearbyUsersList.push({\n      id: doc.id,\n      status: doc.data().status,\n      coordinates: {\n        longitude: doc.data().coordinates.longitude,\n        latitude: doc.data().coordinates.latitude\n      }\n    });\n  });\n  return res.status(200).json({\n    props: {\n      isAuth: true,\n      hasRegisteredDailyStatus: true,\n      user: session.user,\n      nearbyUsers: nearbyUsersList\n    }\n  });\n}","map":{"version":3,"sources":["/home/thiago/Documentos/Dev/Projetos/fullstack-lab/pages/api/nearby-users.js"],"names":["db","auth0","getCurrentDate","req","res","console","log","query","headers","currentDate","userDailyStatus","collection","doc","session","user","sub","get","todayRegistered","data","json","props","isAuth","hasRegisteredDailyStatus","filter","coordinates","body","nearbyUsers","where","near","center","radius","nearbyUsersList","docs","forEach","push","id","status","longitude","latitude"],"mappings":"AAAA,SAASA,EAAT,QAAmB,oBAAnB;AACA,OAAOC,KAAP,MAAkB,iBAAlB;AAEA,OAAOC,cAAP,MAA2B,2BAA3B;AAEA,eAAe,gBAAgBC,GAAhB,EAAqBC,GAArB,EAA0B;AACvCC,EAAAA,OAAO,CAACC,GAAR,CAAYH,GAAG,CAACI,KAAhB;AACAF,EAAAA,OAAO,CAACC,GAAR,CAAYH,GAAG,CAACK,OAAhB,EAFuC,CAGvC;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;;;AAGA,QAAMC,WAAW,GAAGP,cAAc,EAAlC;AAEA,QAAMQ,eAAe,GAAG,MAAMV,EAAE,CAC7BW,UAD2B,CAChB,OADgB,EAE3BC,GAF2B,CAEvBC,OAAO,CAACC,IAAR,CAAaC,GAFU,EAG3BJ,UAH2B,CAGhB,SAHgB,EAI3BC,GAJ2B,CAIvBH,WAJuB,EAK3BO,GAL2B,EAA9B;AAOA,QAAMC,eAAe,GAAGP,eAAe,CAACQ,IAAhB,EAAxB;;AACA,MAAI,CAACD,eAAL,EAAsB;AACpB,WAAOb,GAAG,CAACe,IAAJ,CAAS;AACdC,MAAAA,KAAK,EAAE;AACLC,QAAAA,MAAM,EAAE,IADH;AAELC,QAAAA,wBAAwB,EAAE,KAFrB;AAGLR,QAAAA,IAAI,EAAED,OAAO,CAACC;AAHT;AADO,KAAT,CAAP;AAOD;;AAED,QAAMS,MAAM,GAAGpB,GAAG,CAACI,KAAnB;AACA,QAAMiB,WAAW,GAAGrB,GAAG,CAACsB,IAAxB;AAEA;;;;AAGA,QAAMC,WAAW,GAAG,MAAM1B,EAAE,CACzBW,UADuB,CACZ,SADY,EAEvBC,GAFuB,CAEnB,YAFmB,EAGvBD,UAHuB,CAGZ,KAHY,EAIvBgB,KAJuB,CAIjB,QAJiB,EAIP,IAJO,EAIDJ,MAJC,EAKvBK,IALuB,CAKlB;AACJC,IAAAA,MAAM,EAAEL,WADJ;AAEJM,IAAAA,MAAM,EAAE;AAFJ,GALkB,EASvBd,GATuB,EAA1B;AAWA,QAAMe,eAAe,GAAG,EAAxB;AAEAL,EAAAA,WAAW,CAACM,IAAZ,CAAiBC,OAAjB,CAA0BrB,GAAD,IAAS;AAChCmB,IAAAA,eAAe,CAACG,IAAhB,CAAqB;AACnBC,MAAAA,EAAE,EAAEvB,GAAG,CAACuB,EADW;AAEnBC,MAAAA,MAAM,EAAExB,GAAG,CAACM,IAAJ,GAAWkB,MAFA;AAGnBZ,MAAAA,WAAW,EAAE;AACXa,QAAAA,SAAS,EAAEzB,GAAG,CAACM,IAAJ,GAAWM,WAAX,CAAuBa,SADvB;AAEXC,QAAAA,QAAQ,EAAE1B,GAAG,CAACM,IAAJ,GAAWM,WAAX,CAAuBc;AAFtB;AAHM,KAArB;AAQD,GATD;AAWA,SAAOlC,GAAG,CAACgC,MAAJ,CAAW,GAAX,EAAgBjB,IAAhB,CAAqB;AAC1BC,IAAAA,KAAK,EAAE;AACLC,MAAAA,MAAM,EAAE,IADH;AAELC,MAAAA,wBAAwB,EAAE,IAFrB;AAGLR,MAAAA,IAAI,EAAED,OAAO,CAACC,IAHT;AAILY,MAAAA,WAAW,EAAEK;AAJR;AADmB,GAArB,CAAP;AAQD","sourcesContent":["import { db } from '../../lib/firebase';\nimport auth0 from '../../lib/auth0';\n\nimport getCurrentDate from '../../util/getCurrentDate';\n\nexport default async function (req, res) {\n  console.log(req.query);\n  console.log(req.headers);\n  // const {userId} = req.\n\n  // return res.json({ ok: true });\n  // const session = await auth0.getSession(req);\n\n  // // Verifica se o usuário está logado\n  // if (!session) {\n  //   return res.status(401).json({\n  //     props: {\n  //       isAuth: false,\n  //     },\n  //   });\n  // }\n\n  /*\n   * Verifica se o usuário já cadastrou seu status diario\n   */\n  const currentDate = getCurrentDate();\n\n  const userDailyStatus = await db\n    .collection('users')\n    .doc(session.user.sub)\n    .collection('history')\n    .doc(currentDate)\n    .get();\n\n  const todayRegistered = userDailyStatus.data();\n  if (!todayRegistered) {\n    return res.json({\n      props: {\n        isAuth: true,\n        hasRegisteredDailyStatus: false,\n        user: session.user,\n      },\n    });\n  }\n\n  const filter = req.query;\n  const coordinates = req.body;\n\n  /* Caso o usuário já tenha cadastrado seu status diário, será verificado\n   * todos os usúarios que estao proximos dele\n   */\n  const nearbyUsers = await db\n    .collection('history')\n    .doc('2020-04-20')\n    .collection('all')\n    .where('status', '==', filter)\n    .near({\n      center: coordinates,\n      radius: 10000,\n    })\n    .get();\n\n  const nearbyUsersList = [];\n\n  nearbyUsers.docs.forEach((doc) => {\n    nearbyUsersList.push({\n      id: doc.id,\n      status: doc.data().status,\n      coordinates: {\n        longitude: doc.data().coordinates.longitude,\n        latitude: doc.data().coordinates.latitude,\n      },\n    });\n  });\n\n  return res.status(200).json({\n    props: {\n      isAuth: true,\n      hasRegisteredDailyStatus: true,\n      user: session.user,\n      nearbyUsers: nearbyUsersList,\n    },\n  });\n}\n"]},"metadata":{},"sourceType":"module"}